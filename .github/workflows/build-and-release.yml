name: Build and Release

on:
  push:
    tags:
      - 'v*.*.*'  # Triggers on version tags like v1.0.0, v2.1.3, etc.
  workflow_dispatch:  # Allows manual trigger
    inputs:
      version:
        description: 'Release version (e.g., v1.0.0)'
        required: true
        default: 'v1.0.0'

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        submodules: recursive
    
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y cmake gcc-arm-none-eabi libnewlib-arm-none-eabi build-essential ninja-build
    
    - name: Set up Pico SDK
      run: |
        cd /tmp
        git clone --depth 1 --branch 2.1.1 https://github.com/raspberrypi/pico-sdk.git
        cd pico-sdk
        git submodule update --init
        echo "PICO_SDK_PATH=/tmp/pico-sdk" >> $GITHUB_ENV
    
    - name: Create build directory
      run: mkdir -p build
    
    - name: Configure CMake
      run: |
        cd build
        cmake .. -DCMAKE_BUILD_TYPE=Release -DPICO_BOARD=pico_w
    
    - name: Build project
      run: |
        cd build
        make -j$(nproc)
    
    - name: Verify build artifacts
      run: |
        ls -la build/
        echo "=== Checking for required files ==="
        test -f build/detector-notas-musicais.uf2 && echo "âœ… UF2 file found" || echo "âŒ UF2 file missing"
        test -f build/detector-notas-musicais.elf && echo "âœ… ELF file found" || echo "âŒ ELF file missing"
        test -f build/detector-notas-musicais.bin && echo "âœ… BIN file found" || echo "âŒ BIN file missing"
        test -f build/detector-notas-musicais.hex && echo "âœ… HEX file found" || echo "âŒ HEX file missing"
    
    - name: Get version from tag or input
      id: get_version
      run: |
        if [ "${{ github.event_name }}" = "push" ]; then
          VERSION=${GITHUB_REF#refs/tags/}
        else
          VERSION="${{ github.event.inputs.version }}"
        fi
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "Version: $VERSION"
    
    - name: Create release archive
      run: |
        mkdir -p release-files
        cp build/detector-notas-musicais.uf2 release-files/
        cp build/detector-notas-musicais.elf release-files/
        cp build/detector-notas-musicais.bin release-files/
        cp build/detector-notas-musicais.hex release-files/
        cp README.md release-files/
        
        # Create installation instructions
        cat > release-files/INSTALACAO.md << 'EOF'
        # ðŸ“‹ InstruÃ§Ãµes de InstalaÃ§Ã£o - Detector de Notas Musicais
        
        ## ðŸŽ¯ MÃ©todo 1: InstalaÃ§Ã£o via UF2 (Recomendado)
        
        ### PrÃ©-requisitos
        - Placa BitDogLab (Raspberry Pi Pico W)
        - Cabo USB
        
        ### Passos
        1. **Conecte a placa em modo BOOTSEL:**
           - Segure o botÃ£o BOOTSEL na placa
           - Conecte o cabo USB ao computador
           - Solte o botÃ£o BOOTSEL
           - A placa aparecerÃ¡ como um drive USB chamado "RPI-RP2"
        
        2. **Grave o firmware:**
           - Copie o arquivo `detector-notas-musicais.uf2` para o drive "RPI-RP2"
           - A placa reiniciarÃ¡ automaticamente e executarÃ¡ o programa
        
        ## ðŸ”§ MÃ©todo 2: Usando picotool
        
        ```bash
        # Instale o picotool (se nÃ£o tiver)
        sudo apt install picotool
        
        # Grave o firmware
        picotool load detector-notas-musicais.uf2 -fx
        ```
        
        ## ðŸ“ Arquivos Inclusos
        
        - `detector-notas-musicais.uf2` - **Arquivo principal para gravaÃ§Ã£o**
        - `detector-notas-musicais.elf` - Arquivo executÃ¡vel com sÃ­mbolos de debug
        - `detector-notas-musicais.bin` - Imagem binÃ¡ria do firmware
        - `detector-notas-musicais.hex` - Arquivo em formato Intel HEX
        - `README.md` - DocumentaÃ§Ã£o completa do projeto
        
        ## ðŸŽµ Como Usar
        
        ApÃ³s a instalaÃ§Ã£o, o sistema estarÃ¡ pronto para:
        - Detectar notas musicais atravÃ©s do microfone
        - Exibir informaÃ§Ãµes no display OLED
        - Mostrar representaÃ§Ã£o visual na matriz de LEDs
        - Reproduzir as notas detectadas no buzzer
        
        ## ðŸ†˜ ResoluÃ§Ã£o de Problemas
        
        - **Placa nÃ£o aparece como "RPI-RP2":** Verifique se segurou o botÃ£o BOOTSEL corretamente
        - **Erro ao copiar arquivo:** Certifique-se de que a placa estÃ¡ no modo BOOTSEL
        - **Programa nÃ£o executa:** Verifique se o arquivo .uf2 foi copiado completamente
        
        ---
        
        Para mais informaÃ§Ãµes, consulte o README.md completo.
        EOF
        
        # Create a zip archive
        cd release-files
        zip -r ../detector-notas-musicais-${{ steps.get_version.outputs.version }}.zip .
        cd ..
    
    - name: Create Release
      id: create_release
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ steps.get_version.outputs.version }}
        release_name: "Detector de Notas Musicais ${{ steps.get_version.outputs.version }}"
        body: |
          ## ðŸŽµ Detector e Reprodutor de Notas Musicais - Release ${{ steps.get_version.outputs.version }}
          
          ### ðŸ“¦ Arquivos para Download
          
          - **detector-notas-musicais.uf2** - Arquivo principal para gravaÃ§Ã£o na placa (recomendado)
          - **Pacote completo ZIP** - Todos os arquivos de firmware + documentaÃ§Ã£o
          
          ### ðŸš€ InstalaÃ§Ã£o RÃ¡pida
          
          1. Conecte a BitDogLab segurando o botÃ£o BOOTSEL
          2. Copie o arquivo `.uf2` para o drive "RPI-RP2"
          3. A placa reiniciarÃ¡ automaticamente
          
          ### âœ¨ Funcionalidades
          
          - ðŸŽ¤ DetecÃ§Ã£o de notas musicais via microfone
          - ðŸ“Š AnÃ¡lise FFT em tempo real
          - ðŸ“º Display das informaÃ§Ãµes no OLED
          - ðŸ’¡ RepresentaÃ§Ã£o visual na matriz de LEDs
          - ðŸ”Š ReproduÃ§Ã£o das notas no buzzer
          
          ### ðŸ“‹ InstruÃ§Ãµes Detalhadas
          
          Consulte o arquivo `INSTALACAO.md` incluÃ­do no pacote ZIP para instruÃ§Ãµes completas.
        draft: false
        prerelease: false
    
    - name: Upload UF2 Asset
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: ./release-files/detector-notas-musicais.uf2
        asset_name: detector-notas-musicais.uf2
        asset_content_type: application/octet-stream
    
    - name: Upload Complete Package
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: ./detector-notas-musicais-${{ steps.get_version.outputs.version }}.zip
        asset_name: detector-notas-musicais-${{ steps.get_version.outputs.version }}-complete.zip
        asset_content_type: application/zip
    
    - name: Upload Build Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: build-artifacts-${{ steps.get_version.outputs.version }}
        path: |
          build/detector-notas-musicais.uf2
          build/detector-notas-musicais.elf
          build/detector-notas-musicais.bin
          build/detector-notas-musicais.hex
        retention-days: 90
